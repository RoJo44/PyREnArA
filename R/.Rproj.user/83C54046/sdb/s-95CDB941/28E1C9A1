{
    "collab_server" : "",
    "contents" : "\n###     0. Referenzen\n#\n# RDA ist 'kanonische' PCA:\n# RDA verh?lt sich zu PCA, wie CCA zu CA.\n# Wie PCA erh?lt auch RDA die euklidischen Distanzen\n# der F?lle - allerdings eingeschr?nkt durch die\n# kanonische Bedingung.\n#\n# Referenzen\n#\n#  - M. Greenacre/R. Primicerio, Multivariate Analysis of Ecological Data (2013)\n#\t   freies Online-Buch dort Kap. 13:\n#\t   https://www.fbbva.es/wp-content/uploads/2017/05/dat/DE_2013_multivariate.pdf\n#  - P.Legendre/L.Legendre, Numerical Ecology (Amsterdam 2019)\n#    https://www.worldcat.org/title/numerical-ecology/oclc/1154702375\n#\t   [ISBN:  \t9780444538680]\n#  - D.Borcard/Fr.Gillet/P.Legendre, Numerical Ecology with R (Cham 2018)\n#    https://www.worldcat.org/title/numerical-ecology-with-r/oclc/1032591644\n#\n#############\nrda_test <- function (datfram,filter_list){\n  \n  #datfram[, -c(filter_list)]\n  #lapply(filter_list, function(x) x[!(names(x) %in% c(\"ID\", \"Value\"))])\n  newDF<- datfram[ ,which(!(names(datfram) %in% filter_list)==TRUE)]\n\n}\n\nrda_X <- function(name,datfram,col,r,aim,filt) {\n  #str(datfram)\n  dat_2_1 <- datfram[datfram$typology %in% filt, c('typology', 'ka_cal_BP','region','clust')]#datfram$typology %in% filt, c('typology', 'ka_cal_BP','region','clust')]\n  \n  dat_2_1$typology <- factor(dat_2_1$typology)\n  \n  X <- dat_2_1\n  \n  levels(X$typology)[c(r)] <- aim\n  \n  #levels(X$typology)[c(1,4:7)] <- \"projectilepoints\"\n  \n  write.csv(X,paste0(name,'_projectilepoints','.csv'),sep = \",\",fileEncoding = \"UTF-8\")\n  \n  return (X)\n  \n}\n\nrda_Y <- function(dat,datfram,col,filt) {\n  \n  datfram$typology %in% filt\n  \n  dat <- dat[datfram$typology %in% filt,]\n  \n  Y <- dat\n  \n  #Y <- Y[ !is.na(Y[,1]),]\n  \n  #Y <- Y[,-1]\n  \n  return (Y)\n  \n}\n\nrda_clust <- function (dir,name,datfram,filter_list,clust){\n  \n  ###     1. Daten und Pakete\n  \n  ##    1.1. Daten\n\n  datfram <- datfram [datfram$clust == clust,]\n  # W?hle \"data_metrics_merged_filtered_chrono_ergaenztGR.csv\"\n  \n  #datfram <- read.table(paste0(path), header=TRUE, sep=\",\", dec=\".\", na.strings = \"NA\")\n  #str(datfram)\n  \n  # F?lle (Zeilen) und (numerische) Merkmale (Spalten):\n  # Spalten 2 bis 18 sind die - zumeist (!) - metrischen\n  # Merkmale, Spalte 19 'ka_cal_BP' enth?lt die vermutete\n  # Ursache der Fall?hnlichkeiten im multivariaten Raum, das Alter.\n  \n  #datfram$tip_angle\n  \n  # ACHTUNG: Spalte 16 \"tip_angle\" ist eine Winkelangabe und\n  # sollte NICHT wie eine metrische Variable behandelte werden!\n  # Dieses Merkmal wird hier daher auch weggelassen!\n  #\n  # Zu Winkel-Statistik siehe:\n  #   Arthur Pewsey/Markus Neuh?user/Graeme D Ruxton,\n  #   Circular Statistics in R (Oxford: OUP 2013).\n  \n  \n  # Auswahl ohne Spalten 'Fundname','Winkel' und 'Datierung' # und 'Typologie'\n  # wird Datentabelle f?r Ordination.\n  \n  dat <- datfram[ ,which(!(names(datfram) %in% filter_list)==TRUE)]\n\n  #dat <- datfram[, -c(1,17,20,21)]\n  #str(dat)\n  \n  ##    1.2. Datenbereinigung\n  \n  # ACHTUNG, bei der Datierung ist immer noch ein K?fer im Getriebe!\n  #\n  # Habe die vermutlichen technisch-fehlerhaften Eintr?ge in Spalte\n  # 'ka_cal_BC', die auf \"Antl\" lauteten durch NA ersetzt!\n  \n  #which(is.na(datfram$ka_cal_BP))\n  #sum(is.na(datfram$ka_cal_BP))\n  \n  # Aber 100 Eintr?ge sind betroffen und werden entfernt!\n  #\n  # Folgende Auswahl ist also bei korrektem Datensatz nicht n?tig...\n  \n  #str(dat[ !is.na(datfram$ka_cal_BP),])\n  \n  #filt <- names(which(table(datfram$typology) > 10)) # \n  \n  filt <- names(table(datfram$typology))\n\n  # dat <- dat[datfram$typology %in% filt,]\n  # \n  # Y <- dat\n  # \n  # Y <- Y[ !is.na(Y[,1]),]\n  \n  Y <- rda_Y (dat,datfram,col,filt) \n  \n  str(Y)\n  # Arbeitskopie der Daten, zu denen es eine Datierung gibt\n  \n  #dat_2 <- datfram[datfram$typology %in% filter_list, c('typology', 'ka_cal_BP','region','clust')]\n  \n  # Ebenso Datierungsmerkmal ausw?hlen\n  \n  x <- rda_X (name,datfram,'typologie', c(1,4:7),'projectile_points',filt)\n  str(x)\n  \n  (x <- as.numeric(x$ka_cal_BP[ !is.na(x$ka_cal_BP)]))\n  \n  ##    1.3. Erweiterungspaket\n  # Inventarnamen\n  \n  (invennam <- datfram$ID[ !is.na(datfram$ka_cal_BP)])  # Auswahl ohne NA-F?lle\n  # invennam <- unlist(strsplit(x = invennam, split = \"_\"))\n  #   # Abtrennung des ersten Wortteiles und Wandlung von Liste in Vektor (unlist)\n  # (invennam <- invennam[seq(1,355*3,by=3)])\n  \n  #  \"vegan\"\n  # (Steht f?r \"Veg-etation An-alysis\")\n  # Die K?nigin der R-Pakete f?r Multivariates\n  \n  #install.packages(\"vegan\") # auf Computer f?r R zug?nglich speichern\n  # Zeile nur bei der ersten Nutzung ausf?hren.\n  \n  require(vegan) # in R laden\n  \n  # if (require(vegan)) {\n  #   install.packages('vegan')\n  # }\n  #library(vegan)\n  \n  # R und vegan sind zu zitieren !\n  \n  citation()\n  citation(\"vegan\")\n  \n  print(str(x))\n  print(str(Y))\n  \n  \n  ###     2. RDA\n  \n  \n  ## 2.1. Berechnung\n  \n  res <- vegan::rda(Y~x, scale=TRUE) # RDA\n  \n  # Argument 'scale=TRUE' sorgt daf?r, dass der\n  # PCA-Schritt der RDA auf den Korrelationen beruht,\n  # mit anderen Worten, dass alle Variablen ungef?hr\n  # gleichgewichtet ins Ergebnis eingehen.\n  #\n  # Das ist bei Ihren Daten entscheidend, weil sonst\n  # die Gr??en der Zahlenwerte benutzt werden, und\n  # dann Merkmale wie 'area' alles dominieren w?rden!\n  #\n  # Und ein Merkmal wie 'position_longest_extend' spielte\n  # dann gar keine Rolle mehr!\n  \n  #lapply(Y, summary)\n  \n  \n  ## 2.2. Pr?fung der RDA\n  \n  # ZUALLERERST PR?FEN, OB RDA STRUKTUR ERKANNTE.\n  # Wenn kein signifikanter Test, dann ist Annahme\n  # der Ursache-/Wirkungs-Beziehung zu ?berdenken.\n  \n  anova_cca <- c(vegan::anova.cca(res, alpha=0.05, beta=0.001, perm.max=9999))\n  \n  write.csv(anova_cca,paste0('../../png/R/anova.cca_clust',clust,'.csv'))\n  \n  # Der p-Wert (Zeile 'Model', Spalte 'Pr(>F)' ) ist\n  # einfach der Anteil der Ergebnisse aus 9999 Zufallsw?rfen\n  # plus 1 beobachteten Datenstruktur, also der Anteil\n  # von 10000 RDAs, die soviel Streuung mit ihrer\n  # Ursachenvariablen erkl?ren k?nnen.\n  #\n  # Das Ergebnis der hier verwendeten Daten (ohne ! die Antl-besch?digten)\n  # ist hochsignifikant !!!\n  #\n  # F?r Praktiker: steht rechts an der Tabelle mindestens\n  # ein Sternchen heisst das p kleiner/gleich 0.05.\n  # Hier stehen drei Sternchen = besser geht's net :-)\n  \n  \n  (Anteilerklaert <- vegan::RsquareAdj(res)[[2]])\n  \n  # Allerdings werden nur 2,3 % der Streuung erkl?rt.\n  #\n  # Das bedeutet: ja, es gibt zeitspezifisch Ver?nderungen in den\n  # hier betrachteten Merkmalen, aber diese sind sehr gering!\n  \n  summary(res)$cont # Anteile der Streuung pro Achse\n  \n  # Der Anteil (Zeile 'proportion explained', Spalte 'RDA1')\n  # der RDA-Achse an der Gesamtstreuung ist die noch 'rohe'\n  # Information dar?ber, welchen Anteil an Streuung die\n  # Variable 'ursache' erkl?ren kann.\n  # Beachte: der Wert f?r R-Quadrat wird aus diesem Anteilswert\n  # durch eine leichte Umrechnung erzeugt und dabei immer etwas\n  # kleiner.\n  \n  summary(res)$cont$importance[2,1] # Das ist \"Proportion Explained\" in Spalte \"RDA1\"\n  \n  \n  vector <- c(Anteilerklaert,summary(res)$cont)\n  \n  write.csv(vector,paste0('../../png/R/clust',clust,'.csv'))\n  \n  \n  ##    2.3. Darstellung\n  \n  # 2.3.1. Eigenwertdiagramm (screeplot)\n  \n  # Eigenwertdiagramm kommt IMMER zuerst (auch bei CA, PCA etc.)\n  \n  (eigvalperc <- summary(res)$cont$importance[2,])\n  # Vektor der Streuungsanteile pro Achse\n  \n  (ymax <- round(100*max(eigvalperc)+5,0))\n  # Wie hoch soll das S?ulendiagramm werden ?\n  \n  \n  \n  png(file=paste0(\"../../png/R/01_RDA_Eigenvalue_clust\",clust,\".png\"), width=8333, height=5156, res=1200)\n  \n  barplot(100*eigvalperc, las=2, names.arg=names(eigvalperc), cex.names=.7,\n          space=0, width=1, ylim=c(0,ymax ),\n          main=\"Eigenwertdiagramm\",\n          ylab=\"Prozent erkl?rter Streuung pro Achse\")\n  \n  dev.off()\n  \n  # 2.3.2. Triplot quick and dirty\n  \n  # Triplot-Deutung\n  # - F?lle nah bei einander sind ?hnlich;\n  #   F?lle in Richtung einer Merkmalspfeilspitze haben\n  #   bei diesem Merkmal ?berdurchschnittlich hohe Werte;\n  #   F?lle beim Achsenursprung haben durchschnittliche Werte\n  #   F?lle auf MMpfeil entgegenges. Seite haben unter-\n  #   durchschnittliche Werte.\n  # - Merkmalspfeile, die in ungef?hr gleiche Richtung\n  #   zeigen, nehmen ?berwiegend gemeinsam zu und ab;\n  #   Merkmalspfeile, die in ungef?hr gleiche Richtung\n  #   zeigen wie Ursachenvariable, nehmen mit dieser\n  #   gemeinsam zu und ab.\n  #   Merkmalspfeile, die in ungef?hr rechtinklig zur\n  #   Ursachenvariable liegen, haben zu dieser keine\n  #   Beziehung.\n  \n  \n  \n  # QUICK and DIRTY\n  \n  png(file=paste0(\"../../png/R/03a_RDA_cases_notcoloured_clust\",clust,\".png\"), width=8333, height=5156, res=1200)\n  \n  plot(res, scaling=1, display=c(\"sp\",\"wa\",\"bp\"), las=1)\n  text(res, scaling=1, display=\"sp\", las=1)\n  text(res, scaling=1, display=\"bp\", las=1)\n  \n  dev.off()\n  #\n  \n  # 2.3.3. Triplot mit umfangreichen Details\n  \n  #\tKoordinaten\n  \n  k <- length(eigvalperc)\t# Achsenanzahl\n  \n  # Fall-Koordinaten  (Positionen der Fallpunkte)\n  \n  fallkoo <- \tscores(\tres, choices = c(1:k), display = c(\"sp\",\"wa\",\"bp\"),\n                      scaling = 1, 1)$sites\n  \n  # Merkmals-Koordinaten (Positionen der Merkmals-Pfeilspitzen)\n  \n  mmalkoo <- \tscores(\tres, choices = c(1:k), display = c(\"sp\",\"wa\",\"bp\"),\n                      scaling = 1, 1)$species\n  \n  # Ursachen-Koordinaten (Positionen der Pfeilspitzen)\n  \n  kk <- length(res$CCA$eig)\t# Anzahl kanonischer Achsen, hier 1\n  \n  (covar <- scores(\tres, choices = c(1:k), display = c(\"sp\",\"wa\",\"bp\"),\n                    scaling = \"sites\", 1)$biplot)\n  \n  \n  #\tRichtig anspruchsvoller Triplot\n  \n  # Diagrammgrenze\n  \n  (lim <- 0.7)\n  \n  (lim <- c(-1*lim,lim))\n  \n  # Leeres Diagramm\n  \n  png(file=paste0(\"../../png/R/02_RDA_Triplot_clust\",clust,\".png\"), width=8333, height=5156, res=1200)\n  \n  plot(mmalkoo, type=\"n\", asp=1, xlim=lim, ylim=lim, las=1, xlab=\"\", ylab=\"\")\n  \n  # ein Gitter\n  \n  abline(v=0, lty=3, col=gray(.7))\n  abline(h=0, lty=3, col=gray(.7))\n  \n  # F?lle\n  \n  rcol <- rgb(.8,.8,.8,.3)\t# ein transparentes helles Grau\n  rbcol<- gray(.2)\t\t\t\t# ein dunkles Grau\n  \n  points(fallkoo[,1:2], pch=21, bg=rcol, col=rbcol, cex=0.6)\t# row points\n  \n  # Merkmale\n  \n  cbcol<- gray(.2)\t\t\t\t#\n  \n  arrows(0,0,mmalkoo[,1],mmalkoo[,2], lwd=1, length=.05, angle=15, col=cbcol)\n  \n  tcol <- rgb(.2,.2,.2,.6)\t# Textfarbe\n  text(mmalkoo, rownames(mmalkoo), pos=3, cex=.8, font=3, col=tcol)\t# annotation for cols\n  \n  # Ursachenvariable\n  \n  arrows(0,0,covar[,1],covar[,2], lwd=3, length=.1, angle=15, col=cbcol)\n  text( covar[,1]*1.05, covar[,2]*1.05, \"ka cal BP\", pos=4, cex=1.2, font=4)\n  \n  # Beschriftungen\n  \n  proz   <- round(100*eigvalperc[1:2],1)\n  subtextri <- paste(\"Triplot zeigt\", sum(proz), \"% der gesamten Varianz\")\n  \n  title(main=\"Triplot der RDA (kanonisch ist Ursache)\", cex.axis=.8,\n        xlab=\"RDA I\", ylab=\"PCA I\", sub=subtextri, cex.sub=.8)\n  \n  dev.off()\n  \n  #\tVariante mit Funden eingef?rbt nach Herkunft\n  \n  # Diagrammgrenze\n  \n  (lim <- 0.5)\n  (lim <- c(-1*lim,lim))\n  \n  # Leeres Diagramm\n  \n  png(file=paste0(\"../../png/R/03_RDA_cases_coloured_clust\",clust,\".png\"), width=8333, height=5156, res=1200)\n  \n  plot(0,0, type=\"n\", asp=1, xlim=lim, ylim=lim, las=1, xlab=\"\", ylab=\"\")\n  \n  # ein Gitter\n  \n  abline(v=0, lty=3, col=gray(.7))\n  abline(h=0, lty=3, col=gray(.7))\n\n  # F?lle\n  \n  (tk <- nlevels(as.factor(x))) # 13 Zeitstufen\n  xfac <- as.factor(x) # Zeitstufen als Nominalmerkmal\n  \n  points(fallkoo[,1:2], pch=21, bg=rainbow(13)[xfac], col=rbcol, cex=0.7)\t# row points\n  \n  # Legende\n\n  legend(\"right\", pch=rep(21,13), pt.bg=rainbow(13), unique(invennam ))\n  \n  title(main=\"RDA: Streudiagramm der F?lle\", cex.axis=.8,\n        xlab=\"RDA I\", ylab=\"PCA I\")\n\n  dev.off()\n  \n  \n  #####################################\n  #\n  # Deutung:\n  #\n  # Nach rechts werden die Funde ?lter.\n  # Merkmale, deren Pfeile nach rechts zeigen, haben h?here Werte\n  # bei ?lteren St?cken, solche die nach links zeigen h?here Werte\n  # bei j?ngeren St?cken.\n  \n  \n  \n  # 2.3.4. Jeweils pro Merkmal von Ursache erkl?rte Streuung\n  \n  (inrexp <- inertcomp(object = res, display = \"species\", proportional = TRUE))\n  \n  \n  yvlim <- 10\n  \n  ranks <- order(inrexp[,1]) # Vektor der Gr??en-Reihenfolge der Anteile\n  \n  # Zul?ssige Druckgrenzen ?ndern\n  \n  oldpar <- par() # Grundeinstellungen hinterlegen\n  par(mar = c(8,4,4,1)) # Grenzen ?ndern\n  \n  # Diagramm\n  \n  png(file=paste0(\"../../png/R/04_RDA_scattering_per_trait_clust\",clust,\".png\"), width=8333, height=5156, res=1200)\n  \n  barplot(100*inrexp[ranks,1], names.arg=rownames(inrexp)[ranks], las=2,\n          cex.names=.7, space=0, width=1, ylim=c(0,yvlim))\n  \n  title(main=\"Kanonisch erkl?rte Varianz des jeweiligen Merkmals\",\n        ylab=\"Prozent erkl?rter Streuung bei Merkmal\")\n  \n  dev.off()\n  \n  # Diagramm erweitert\n  \n  # Jetzt wird mit nega- oder positivem Wert angezeigt,\n  # ob Merkmalswerte mit Alter ab- oder zunehmen.\n  \n  (negpos <- ifelse(mmalkoo[,1]<0, -1,1))\n  \n  # logische Frage, ob Zahlen negativ; bei ja '-1', bei nein '+1'\n  \n  ranks2 <- order(negpos*inrexp[,1]) # Vektor der Gr??en-Reihenfolge der Anteile\n  \n  png(file=paste0(\"../../png/R/05_RDA_scattering_per_trait_orientated_clust\",clust,\".png\"), width=8333, height=5156, res=1200)\n  \n  \n  barplot((negpos*100*inrexp[,1])[ranks2], names.arg=rownames(inrexp)[ranks2], las=2,\n          cex.names=.7, space=0, width=1, ylim=c(-yvlim,yvlim))\n  \n  title(main=\"Kanonisch erkl?rte Varianz des jeweiligen Merkmals\",\n        ylab=\"Abnahme  -- Prozent erkl?rter Streuung -- Zunahme\")\n  \n  dev.off()\n  dev.off()\n  #####################################\n  #\n  # Deutung:\n  #\n  # Welcher Anteil der Streuung eines Merkmals ist alleine anhand\n  # des Kausalmerkmals sch?tzbar (hier ausgedr?ckt in Prozent)\n  # und nehmen die Merkmalswerte mit dem Alter zu (positiv/oberhalb\n  # Nulllinie) oder ab (unterhalb).\n  \n  \n  #############\n  \n  # Export rda data \n  sc_si <- scores(res, display=\"sites\", choices=c(1), scaling=1)\n  datfram$RDA <- sc_si[,1]\n  write.csv(datfram,paste0(dir,name,clust,'_rda.csv'), col.names = T, sep=\",\",fileEncoding =\"UTF-8\")\n  \n}\n\nrda_all <- function (dir,name,datfram,filter_list){\n  \n  ###     1. Daten und Pakete\n  \n  ##    1.1. Daten\n  \n  # W?hle \"data_metrics_merged_filtered_chrono_ergaenztGR.csv\"\n  \n  #datfram <- read.table(paste0(path), header=TRUE, sep=\",\", dec=\".\", na.strings = \"NA\")\n  #str(datfram)\n  \n  # F?lle (Zeilen) und (numerische) Merkmale (Spalten):\n  # Spalten 2 bis 18 sind die - zumeist (!) - metrischen\n  # Merkmale, Spalte 19 'ka_cal_BP' enth?lt die vermutete\n  # Ursache der Fall?hnlichkeiten im multivariaten Raum, das Alter.\n  \n  #datfram$tip_angle\n  \n  # ACHTUNG: Spalte 16 \"tip_angle\" ist eine Winkelangabe und\n  # sollte NICHT wie eine metrische Variable behandelte werden!\n  # Dieses Merkmal wird hier daher auch weggelassen!\n  #\n  # Zu Winkel-Statistik siehe:\n  #   Arthur Pewsey/Markus Neuh?user/Graeme D Ruxton,\n  #   Circular Statistics in R (Oxford: OUP 2013).\n  \n  \n  # Auswahl ohne Spalten 'Fundname','Winkel' und 'Datierung' # und 'Typologie'\n  # wird Datentabelle f?r Ordination.\n  \n  dat <- datfram[ ,which(!(names(datfram) %in% filter_list)==TRUE)]\n  \n  #dat <- datfram[, -c(1,17,20,21)]\n  #str(dat)\n  \n  ##    1.2. Datenbereinigung\n  \n  # ACHTUNG, bei der Datierung ist immer noch ein K?fer im Getriebe!\n  #\n  # Habe die vermutlichen technisch-fehlerhaften Eintr?ge in Spalte\n  # 'ka_cal_BC', die auf \"Antl\" lauteten durch NA ersetzt!\n  \n  #which(is.na(datfram$ka_cal_BP))\n  #sum(is.na(datfram$ka_cal_BP))\n  \n  # Aber 100 Eintr?ge sind betroffen und werden entfernt!\n  #\n  # Folgende Auswahl ist also bei korrektem Datensatz nicht n?tig...\n  \n  #str(dat[ !is.na(datfram$ka_cal_BP),])\n  \n  #filt <- names(which(table(datfram$typology) >= 10)) # \n  filt <- names(table(datfram$typology))\n  \n  #filt <- names(table(datfram$typology)) # \n  # dat <- dat[datfram$typology %in% filt,]\n  # \n  # Y <- dat\n  # \n  # Y <- Y[ !is.na(Y[,1]),]\n  \n  Y <- rda_Y (dat,datfram,col,filt) \n  \n  \n  # Arbeitskopie der Daten, zu denen es eine Datierung gibt\n  \n  #dat_2 <- datfram[datfram$typology %in% filter_list, c('typology', 'ka_cal_BP','region','clust')]\n  \n  # Ebenso Datierungsmerkmal ausw?hlen\n  \n  x <- rda_X (name,datfram,'typologie', c(1,4:7),'projectile_points',filt)\n  \n  \n  (x <- as.numeric(x$ka_cal_BP[ !is.na(x$ka_cal_BP)]))\n  \n  ##    1.3. Erweiterungspaket\n  # Inventarnamen\n  \n  (invennam <- datfram$ID[ !is.na(datfram$ka_cal_BP)])  # Auswahl ohne NA-F?lle\n  # invennam <- unlist(strsplit(x = invennam, split = \"_\"))\n  #   # Abtrennung des ersten Wortteiles und Wandlung von Liste in Vektor (unlist)\n  # (invennam <- invennam[seq(1,355*3,by=3)])\n  \n  #  \"vegan\"\n  # (Steht f?r \"Veg-etation An-alysis\")\n  # Die K?nigin der R-Pakete f?r Multivariates\n  \n  #install.packages(\"vegan\") # auf Computer f?r R zug?nglich speichern\n  # Zeile nur bei der ersten Nutzung ausf?hren.\n  \n  require(vegan) # in R laden\n  \n  # if (require(vegan)) {\n  #   install.packages('vegan')\n  # }\n  #library(vegan)\n  \n  # R und vegan sind zu zitieren !\n  \n  citation()\n  citation(\"vegan\")\n  \n  str(x)\n  str(Y)\n  \n  \n  ###     2. RDA\n  \n  \n  ## 2.1. Berechnung\n  \n  res <- vegan::rda(Y~x, scale=TRUE) # RDA\n  \n  # Argument 'scale=TRUE' sorgt daf?r, dass der\n  # PCA-Schritt der RDA auf den Korrelationen beruht,\n  # mit anderen Worten, dass alle Variablen ungef?hr\n  # gleichgewichtet ins Ergebnis eingehen.\n  #\n  # Das ist bei Ihren Daten entscheidend, weil sonst\n  # die Gr??en der Zahlenwerte benutzt werden, und\n  # dann Merkmale wie 'area' alles dominieren w?rden!\n  #\n  # Und ein Merkmal wie 'position_longest_extend' spielte\n  # dann gar keine Rolle mehr!\n  \n  #lapply(Y, summary)\n  \n  \n  ## 2.2. Pr?fung der RDA\n  \n  # ZUALLERERST PR?FEN, OB RDA STRUKTUR ERKANNTE.\n  # Wenn kein signifikanter Test, dann ist Annahme\n  # der Ursache-/Wirkungs-Beziehung zu ?berdenken.\n  \n  anova_cca <- vegan::anova.cca(res, alpha=0.05, beta=0.001, perm.max=100000)\n  \n  write.csv(anova_cca,paste0('../../png/R/anova.cca.csv'))\n  \n  # Der p-Wert (Zeile 'Model', Spalte 'Pr(>F)' ) ist\n  # einfach der Anteil der Ergebnisse aus 9999 Zufallsw?rfen\n  # plus 1 beobachteten Datenstruktur, also der Anteil\n  # von 10000 RDAs, die soviel Streuung mit ihrer\n  # Ursachenvariablen erkl?ren k?nnen.\n  #\n  # Das Ergebnis der hier verwendeten Daten (ohne ! die Antl-besch?digten)\n  # ist hochsignifikant !!!\n  #\n  # F?r Praktiker: steht rechts an der Tabelle mindestens\n  # ein Sternchen heisst das p kleiner/gleich 0.05.\n  # Hier stehen drei Sternchen = besser geht's net :-)\n  \n  \n  (Anteilerklaert <- vegan::RsquareAdj(res)[[2]])\n  \n  # Allerdings werden nur 2,3 % der Streuung erkl?rt.\n  #\n  # Das bedeutet: ja, es gibt zeitspezifisch Ver?nderungen in den\n  # hier betrachteten Merkmalen, aber diese sind sehr gering!\n  \n  summary(res)$cont # Anteile der Streuung pro Achse\n  \n  # Der Anteil (Zeile 'proportion explained', Spalte 'RDA1')\n  # der RDA-Achse an der Gesamtstreuung ist die noch 'rohe'\n  # Information dar?ber, welchen Anteil an Streuung die\n  # Variable 'ursache' erkl?ren kann.\n  # Beachte: der Wert f?r R-Quadrat wird aus diesem Anteilswert\n  # durch eine leichte Umrechnung erzeugt und dabei immer etwas\n  # kleiner.\n  \n  summary(res)$cont$importance[2,1] # Das ist \"Proportion Explained\" in Spalte \"RDA1\"\n  Anteilerklaert\n  \n  vector <- c(Anteilerklaert,summary(res)$cont)\n  \n  write.csv(vector,paste0('../../png/R/clust.csv'))\n  \n  \n  \n  \n  \n  ##    2.3. Darstellung\n  \n  # 2.3.1. Eigenwertdiagramm (screeplot)\n  \n  # Eigenwertdiagramm kommt IMMER zuerst (auch bei CA, PCA etc.)\n  \n  (eigvalperc <- summary(res)$cont$importance[2,])\n  # Vektor der Streuungsanteile pro Achse\n  \n  (ymax <- round(100*max(eigvalperc)+5,0))\n  # Wie hoch soll das S?ulendiagramm werden ?\n  \n  \n  \n  png(file=\"../../png/R/01_RDA_Eigenvalue.png\", width=8333, height=5156, res=1200)\n  \n  barplot(100*eigvalperc, las=2, names.arg=names(eigvalperc), cex.names=.7,\n          space=0, width=1, ylim=c(0,ymax ),\n          main=\"Eigenwertdiagramm\",\n          ylab=\"Prozent erkl?rter Streuung pro Achse\")\n  \n  dev.off()\n  \n  # 2.3.2. Triplot quick and dirty\n  \n  # Triplot-Deutung\n  # - F?lle nah bei einander sind ?hnlich;\n  #   F?lle in Richtung einer Merkmalspfeilspitze haben\n  #   bei diesem Merkmal ?berdurchschnittlich hohe Werte;\n  #   F?lle beim Achsenursprung haben durchschnittliche Werte\n  #   F?lle auf MMpfeil entgegenges. Seite haben unter-\n  #   durchschnittliche Werte.\n  # - Merkmalspfeile, die in ungef?hr gleiche Richtung\n  #   zeigen, nehmen ?berwiegend gemeinsam zu und ab;\n  #   Merkmalspfeile, die in ungef?hr gleiche Richtung\n  #   zeigen wie Ursachenvariable, nehmen mit dieser\n  #   gemeinsam zu und ab.\n  #   Merkmalspfeile, die in ungef?hr rechtinklig zur\n  #   Ursachenvariable liegen, haben zu dieser keine\n  #   Beziehung.\n  \n  \n  \n  # QUICK and DIRTY\n  \n  png(file=\"../../png/R/03a_RDA_cases_notcoloured.png\", width=8333, height=5156, res=1200)\n  \n  plot(res, scaling=1, display=c(\"sp\",\"wa\",\"bp\"), las=1)\n  text(res, scaling=1, display=\"sp\", las=1)\n  text(res, scaling=1, display=\"bp\", las=1)\n  \n  dev.off()\n  #\n  \n  # 2.3.3. Triplot mit umfangreichen Details\n  \n  #\tKoordinaten\n  \n  k <- length(eigvalperc)\t# Achsenanzahl\n  \n  # Fall-Koordinaten  (Positionen der Fallpunkte)\n  \n  fallkoo <- \tscores(\tres, choices = c(1:k), display = c(\"sp\",\"wa\",\"bp\"),\n                      scaling = 1, 1)$sites\n  \n  # Merkmals-Koordinaten (Positionen der Merkmals-Pfeilspitzen)\n  \n  mmalkoo <- \tscores(\tres, choices = c(1:k), display = c(\"sp\",\"wa\",\"bp\"),\n                      scaling = 1, 1)$species\n  \n  # Ursachen-Koordinaten (Positionen der Pfeilspitzen)\n  \n  kk <- length(res$CCA$eig)\t# Anzahl kanonischer Achsen, hier 1\n  \n  (covar <- scores(\tres, choices = c(1:k), display = c(\"sp\",\"wa\",\"bp\"),\n                    scaling = \"sites\", 1)$biplot)\n  \n  \n  #\tRichtig anspruchsvoller Triplot\n  \n  # Diagrammgrenze\n  \n  (lim <- 0.5)\n  \n  (lim <- c(-1*lim,lim))\n  \n  # Leeres Diagramm\n  \n  png(file=\"../../png/R/02_RDA_Triplot.png\", width=8333, height=5156, res=1200)\n  \n  plot(mmalkoo, type=\"n\", asp=1, xlim=lim, ylim=lim, las=1, xlab=\"\", ylab=\"\")\n  \n  # ein Gitter\n  \n  abline(v=0, lty=3, col=gray(.7))\n  abline(h=0, lty=3, col=gray(.7))\n  \n  # F?lle\n  \n  rcol <- rgb(.8,.8,.8,.3)\t# ein transparentes helles Grau\n  rbcol<- gray(.2)\t\t\t\t# ein dunkles Grau\n  \n  points(fallkoo[,1:2], pch=21, bg=rcol, col=rbcol, cex=0.6)\t# row points\n  \n  # Merkmale\n  \n  cbcol<- gray(.2)\t\t\t\t#\n  \n  arrows(0,0,mmalkoo[,1],mmalkoo[,2], lwd=1, length=.05, angle=15, col=cbcol)\n  \n  tcol <- rgb(.2,.2,.2,.6)\t# Textfarbe\n  text(mmalkoo, rownames(mmalkoo), pos=3, cex=.8, font=3, col=tcol)\t# annotation for cols\n  \n  # Ursachenvariable\n  \n  arrows(0,0,covar[,1],covar[,2], lwd=3, length=.1, angle=15, col=cbcol)\n  text( covar[,1]*1.05, covar[,2]*1.05, \"ka cal BP\", pos=4, cex=1.2, font=4)\n  \n  # Beschriftungen\n  \n  proz   <- round(100*eigvalperc[1:2],1)\n  subtextri <- paste(\"Triplot zeigt\", sum(proz), \"% der gesamten Varianz\")\n  \n  title(main=\"Triplot der RDA (kanonisch ist Ursache)\", cex.axis=.8,\n        xlab=\"RDA I\", ylab=\"PCA I\", sub=subtextri, cex.sub=.8)\n  \n  dev.off()\n  \n  #\tVariante mit Funden eingef?rbt nach Herkunft\n  \n  # Diagrammgrenze\n  \n  (lim <- 0.5)\n  (lim <- c(-1*lim,lim))\n  \n  # Leeres Diagramm\n  \n  png(file=\"../../png/R/03_RDA_cases_coloured.png\", width=8333, height=5156, res=1200)\n  \n  plot(0,0, type=\"n\", asp=1, xlim=lim, ylim=lim, las=1, xlab=\"\", ylab=\"\")\n  \n  # ein Gitter\n  \n  abline(v=0, lty=3, col=gray(.7))\n  abline(h=0, lty=3, col=gray(.7))\n\n  # F?lle\n  \n  (tk <- nlevels(as.factor(x))) # 13 Zeitstufen\n  xfac <- as.factor(x) # Zeitstufen als Nominalmerkmal\n  \n  points(fallkoo[,1:2], pch=21, bg=rainbow(13)[xfac], col=rbcol, cex=0.7)\t# row points\n  \n  # Legende\n\n  legend(\"right\", pch=rep(21,13), pt.bg=rainbow(13), unique(invennam ))\n  \n  title(main=\"RDA: Streudiagramm der F?lle\", cex.axis=.8,\n        xlab=\"RDA I\", ylab=\"PCA I\")\n\n  dev.off()\n  \n  \n  #####################################\n  #\n  # Deutung:\n  #\n  # Nach rechts werden die Funde ?lter.\n  # Merkmale, deren Pfeile nach rechts zeigen, haben h?here Werte\n  # bei ?lteren St?cken, solche die nach links zeigen h?here Werte\n  # bei j?ngeren St?cken.\n  \n  \n  \n  # 2.3.4. Jeweils pro Merkmal von Ursache erkl?rte Streuung\n  \n  (inrexp <- inertcomp(object = res, display = \"species\", proportional = TRUE))\n  \n  \n  yvlim <- 10\n  \n  ranks <- order(inrexp[,1]) # Vektor der Gr??en-Reihenfolge der Anteile\n  \n  # Zul?ssige Druckgrenzen ?ndern\n  \n  oldpar <- par() # Grundeinstellungen hinterlegen\n  par(mar = c(8,4,4,1)) # Grenzen ?ndern\n  \n  # Diagramm\n  \n  png(file=\"../../png/R/04_RDA_scattering_per_trait.png\", width=8333, height=5156, res=1200)\n  \n  barplot(100*inrexp[ranks,1], names.arg=rownames(inrexp)[ranks], las=2,\n          cex.names=.7, space=0, width=1, ylim=c(0,yvlim))\n  \n  title(main=\"Kanonisch erkl?rte Varianz des jeweiligen Merkmals\",\n        ylab=\"Prozent erkl?rter Streuung bei Merkmal\")\n  \n  dev.off()\n  \n  # Diagramm erweitert\n  \n  # Jetzt wird mit nega- oder positivem Wert angezeigt,\n  # ob Merkmalswerte mit Alter ab- oder zunehmen.\n  \n  (negpos <- ifelse(mmalkoo[,1]<0, -1,1))\n  \n  # logische Frage, ob Zahlen negativ; bei ja '-1', bei nein '+1'\n  \n  ranks2 <- order(negpos*inrexp[,1]) # Vektor der Gr??en-Reihenfolge der Anteile\n  \n  png(file=\"../../png/R/05_RDA_scattering_per_trait_orientated.png\", width=8333, height=5156, res=1200)\n  \n  barplot((negpos*100*inrexp[,1])[ranks2], names.arg=rownames(inrexp)[ranks2], las=2,\n          cex.names=.7, space=0, width=1, ylim=c(-yvlim,yvlim))\n  \n  title(main=\"Kanonisch erkl?rte Varianz des jeweiligen Merkmals\",\n        ylab=\"Abnahme  -- Prozent erkl?rter Streuung -- Zunahme\")\n  \n  dev.off()\n  dev.off()\n  #####################################\n  #\n  # Deutung:\n  #\n  # Welcher Anteil der Streuung eines Merkmals ist alleine anhand\n  # des Kausalmerkmals sch?tzbar (hier ausgedr?ckt in Prozent)\n  # und nehmen die Merkmalswerte mit dem Alter zu (positiv/oberhalb\n  # Nulllinie) oder ab (unterhalb).\n  \n  \n  \n  #############\n  \n  # Export rda data \n  sc_si <- scores(res, display=\"sites\", choices=c(1,2), scaling=1)\n  datfram$RDA <- sc_si[,1:2]\n  write.csv(datfram,paste0(dir,name,'_rda.csv'), col.names = T, sep=\",\",fileEncoding =\"UTF-8\")\n  \n  return (datfram)\n  \n}\n\nrda <- function (dir,name,datfram,filter_list){\n\n  for (clust in unique(datfram$clust)){\n    rda_clust(dir,name,datfram,filter_list,clust)\n    \n  }\n  \n  return (rda_all(dir,name,datfram,filter_list))\n  \n}\n\ndir <- '../../project/'\n\nname <- 'data_metrics_exclusive_FD_filtered_clust'\n\ndatfram <- read.csv(paste0(dir,name,'.csv'), header = T, sep=\",\",encoding =\"UTF-8\",stringsAsFactors=FALSE)\n\nnames <- c('FD','MP_CM_x_offset','MP_CM_y_offset','tip_angle')\n\ndatfram[,names] <- lapply(datfram[,names] , as.numeric)\n\n#datafram <- datfram[datfram$class == 1,]\n\nfilter_list <- c('ID', 'X','Unnamed..0','ID.1','class','tip_angle','position_widest_extend','reference','class_old','position_longest_extend','ka_cal_BP','typology','region','site','clust','clas','length_lower_part' , 'length_upper_part','width_left_part','width_right_part' )\n\n#filter_list <- c('ID', 'X','Unnamed..0','ID.1','class','tip_angle','position_widest_extend','reference','class_old','position_longest_extend','ka_cal_BP','typology','region','site','clust','clas')#,'length_lower_part' , 'length_upper_part','width_left_part','width_right_part' )\n\n#'typology','region','site','clust'\n\nrda (dir,name,datfram,filter_list)\n",
    "created" : 1660149732019.000,
    "dirty" : false,
    "encoding" : "UTF-8",
    "folds" : "",
    "hash" : "2128041333",
    "id" : "28E1C9A1",
    "lastKnownWriteTime" : 1660152239,
    "last_content_update" : 1660152239792,
    "path" : "~/Documents/Projekt/ArchaeoCod_Linsel/code/R/rda_marcel.R",
    "project_path" : "rda_marcel.R",
    "properties" : {
    },
    "relative_order" : 3,
    "source_on_save" : false,
    "source_window" : "",
    "type" : "r_source"
}